#
# PYNQ-Z2 Robot System Local Configuration
# This file contains local configuration for the PYNQ-Z2 LiDAR SLAM and CV robot system
#

# Machine Selection - PYNQ-Z2 based on Zynq-7020
MACHINE = "qemuarm"

# Target Distribution - Use latest stable
DISTRO = "poky"

# Package Management
PACKAGE_CLASSES = "package_rpm"

# SDK and Cross-toolchain
SDKMACHINE = "x86_64"

# Build optimization - adjust based on your build machine
# Use number of CPU cores available (adjust as needed)
BB_NUMBER_THREADS = "4"
PARALLEL_MAKE = "-j 4"

# Work around case-insensitive filesystem on macOS (disable sanity check)
SANITY_TESTED_DISTROS = ""
SKIP_SANITY_BBAPPEND_CHECK = "1"

# Disk space monitoring
BB_DISKMON_DIRS = "\
    STOPTASKS,${TMPDIR},1G,100K \
    STOPTASKS,${DL_DIR},1G,100K \
    STOPTASKS,${SSTATE_DIR},1G,100K \
    STOPTASKS,/tmp,100M,100K \
    ABORT,${TMPDIR},100M,1K \
    ABORT,${DL_DIR},100M,1K \
    ABORT,${SSTATE_DIR},100M,1K \
    ABORT,/tmp,10M,1K"

# Hash Equivalence and Shared State
#BB_HASHSERVER_UPSTREAM = "hashserv.yocto.io:8687"
#SSTATE_MIRRORS = "file://.* https://sstate.yoctoproject.org/all/PATH;downloadfilename=PATH"

# Additional image features for robot system
EXTRA_IMAGE_FEATURES = "\
    debug-tweaks \
    tools-debug \
    tools-profile \
    ssh-server-openssh \
    package-management \
    splash \
"

# Core image features
IMAGE_FEATURES += "\
    hwcodecs \
    nfs-server \
    tools-debug \
    tools-profile \
    tools-testapps \
    x11-base \
"

# System packages for robot functionality
IMAGE_INSTALL:append = " \
    kernel-modules \
    openssh \
    openssh-sftp-server \
    python3 \
    python3-modules \
    python3-pip \
    python3-numpy \
    python3-opencv \
    cmake \
    git \
    wget \
    curl \
    htop \
    nano \
    vim \
    i2c-tools \
    can-utils \
    usbutils \
    pciutils \
    ethtool \
    iperf3 \
    tcpdump \
    screen \
    tmux \
    rsync \
    ntp \
    tzdata \
"

# ROS2 packages (when meta-ros is included)
IMAGE_INSTALL:append = " \
    ros-core \
    ros-base \
"

# OpenCV and Computer Vision packages
IMAGE_INSTALL:append = " \
    opencv \
    opencv-apps \
    opencv-samples \
    v4l-utils \
    media-ctl \
"

# Development tools
IMAGE_INSTALL:append = " \
    gcc \
    g++ \
    make \
    cmake \
    gdb \
    strace \
    ltrace \
    binutils \
    file \
"

# Network and connectivity
IMAGE_INSTALL:append = " \
    wireless-regdb \
    wpa-supplicant \
    iw \
    hostapd \
    dhcp-client \
    dhcp-server \
    bridge-utils \
    iptables \
"

# Filesystem support
IMAGE_INSTALL:append = " \
    e2fsprogs \
    e2fsprogs-resize2fs \
    dosfstools \
    util-linux \
    parted \
"

# Python packages for PYNQ and robot development
IMAGE_INSTALL:append = " \
    python3-pynq \
    python3-jupyter \
    python3-matplotlib \
    python3-scipy \
    python3-pandas \
    python3-pillow \
    python3-requests \
    python3-flask \
    python3-tornado \
    python3-zmq \
    python3-serial \
    python3-smbus \
"

# Xilinx and FPGA tools
IMAGE_INSTALL:append = " \
    xrt \
    zocl \
    opencl-headers \
    opencl-icd-loader \
"

# Root filesystem size (adjust as needed for your SD card)
IMAGE_ROOTFS_EXTRA_SPACE = "2048000"

# Enable systemd instead of SysV init
DISTRO_FEATURES:append = " systemd"
VIRTUAL-RUNTIME_init_manager = "systemd"
VIRTUAL-RUNTIME_initscripts = ""

# Enable additional features
DISTRO_FEATURES:append = " \
    wifi \
    bluetooth \
    3g \
    nfc \
    x11 \
    wayland \
    opengl \
    opencl \
    vulkan \
"

# Kernel configuration
PREFERRED_PROVIDER_virtual/kernel = "linux-xlnx"
PREFERRED_VERSION_linux-xlnx = "6.1%"

# U-Boot configuration
PREFERRED_PROVIDER_virtual/bootloader = "u-boot-xlnx"
PREFERRED_PROVIDER_u-boot = "u-boot-xlnx"

# Enable UART console
SERIAL_CONSOLES = "115200;ttyPS0"

# Boot files and configuration
KERNEL_IMAGETYPE = "uImage"
KERNEL_CLASSES = "kernel-uimage"

# Enable device tree overlay support
KERNEL_DEVICETREE:append = " \
    zynq-pynqz2.dtb \
"

# License handling
LICENSE_FLAGS_ACCEPTED = "commercial synaptics-killswitch"

# Remove conflicting packages that might cause boot issues
PACKAGE_EXCLUDE = ""

# Security and hardening features
DISTRO_FEATURES:append = " \
    pam \
    polkit \
"

# Enable real-time kernel features for robotics
DISTRO_FEATURES:append = " preempt-rt"

# Yocto compatibility
CONF_VERSION = "2"